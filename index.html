<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R-ESTATE TERMINAL</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PapaParse for CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Noto+Sans+KR:wght@400;700&display=swap');
        
        :root {
            --terminal-bg: #000000;
            --terminal-text: #ffb000;
        }

        body { 
            font-family: 'Noto Sans KR', sans-serif; 
            background-color: var(--terminal-bg); 
            color: var(--terminal-text); 
            margin: 0;
            padding: 0;
        }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Ïä§ÌÅ¨Î°§Î∞î Ïª§Ïä§ÌÖÄ */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* ÌÑ∞ÎØ∏ÎÑê Ìè¥Îçî Ïä§ÌÉÄÏùº */
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details > summary::before { content: '[+] '; color: #555; font-size: 11px; margin-right: 4px; }
        details[open] > summary::before { content: '[-] '; color: #00ffff; }

        .ticker-animate { transition: opacity 0.3s ease; }
        .hover-panel { transition: all 0.2s ease-in-out; }
        
        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2300ffff'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1em;
            padding-right: 2.5rem !important;
        }

        .filter-btn:hover { background-color: #1a1a1a; color: #ffffff; }
        .reset-btn:hover { background-color: #ff0000; color: #ffffff; border-color: #ff0000; }
        
        /* ÏÑ†ÌÉùÎêú ÎÇ†Ïßú ÎÖ∏Îìú ÌïòÏù¥ÎùºÏù¥Ìä∏ */
        .date-active { background-color: #333333; color: #ffffff !important; font-weight: bold; border-left: 2px solid #00ffff; padding-left: 6px !important; }
    </style>
</head>
<body class="p-2 md:p-4 text-[13px] tracking-tight font-mono">
    <!-- Î©îÏù∏ Î†àÏù¥ÏïÑÏõÉ -->
    <div class="max-w-[1600px] mx-auto flex flex-col lg:flex-row gap-3 items-start">
        
        <!-- üóÇÔ∏è LEFT SIDEBAR: TIME ARCHIVE (Í∏∞Î≥∏ Ïà®ÍπÄ) -->
        <div id="timeArchiveSidebar" class="hidden w-full lg:w-[260px] border border-[#333333] shadow-2xl bg-[#050505] flex-shrink-0 flex-col h-[300px] lg:h-[calc(100vh-2rem)] sticky top-4">
            <div class="p-2 border-b border-[#333333] bg-[#111111] font-bold text-white tracking-widest text-[11px] flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#00ffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
                    ARCHIVE EXPLORER
                </div>
                <span class="text-[#555] text-[9px]">DIR_TREE</span>
            </div>
            
            <div class="p-3 overflow-y-auto flex-1 text-xs" id="sidebar-tree">
                <div class="text-center text-[#555] mt-10 animate-pulse">LOADING ARCHIVE...</div>
                <!-- JS Î†åÎçîÎßÅ ÏòÅÏó≠ -->
            </div>
            
            <div class="p-2 bg-[#111111] border-t border-[#333333] text-[9px] text-[#555555] text-center tracking-widest">
                SELECT DATE TO FILTER
            </div>
        </div>

        <!-- üñ•Ô∏è RIGHT MAIN: TERMINAL DASHBOARD -->
        <div class="flex-1 w-full border border-[#333333] shadow-2xl bg-[#050505] relative overflow-hidden flex flex-col min-w-0">
            
            <!-- Header / Control Bar -->
            <div class="flex flex-col xl:flex-row items-start xl:items-center justify-between p-2 md:p-3 border-b border-[#333333] bg-[#111111]">
                <div class="flex items-center gap-3 mb-3 xl:mb-0">
                    <!-- üöÄ NEW: Archive Toggle Button -->
                    <button id="toggleArchiveBtn" class="flex items-center gap-1 border border-[#333333] bg-black hover:bg-[#1a1a1a] text-[#00ffff] px-2 py-1.5 text-[11px] font-bold tracking-widest transition-colors rounded-sm shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
                        <span id="archiveBtnText">[+] TIME ARCHIVE</span>
                    </button>

                    <h1 class="font-bold text-base text-white flex items-center gap-2 tracking-widest uppercase ml-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#00ffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 17 10 11 4 5"></polyline><line x1="12" y1="19" x2="20" y2="19"></line></svg>
                        R-ESTATE TERMINAL
                    </h1>
                    <div class="flex gap-2 text-xs ml-2" id="top-stats">
                        <span class="text-[#00ffff]">TOT: 0</span>
                        <span class="text-[#00ff00]">BUL: 0</span>
                        <span class="text-[#ff0000]">BER: 0</span>
                    </div>
                </div>
                
                <div class="flex flex-wrap items-center gap-2">
                    <!-- Reset Button -->
                    <button id="resetAllFilters" class="reset-btn border border-[#ff0000] text-[#ff0000] text-[11px] px-3 py-1 font-bold transition-all bg-transparent rounded-sm flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg>
                        [!] RESET
                    </button>

                    <!-- Dropdown Filters -->
                    <select id="regionFilter" class="border border-[#333333] bg-black text-xs px-3 py-1 font-bold text-[#00ffff] outline-none hover:bg-[#1a1a1a] cursor-pointer rounded-sm min-w-[110px]">
                        <option value="ALL">REG: ALL</option>
                    </select>
                    <select id="keywordFilter" class="border border-[#333333] bg-black text-xs px-3 py-1 font-bold text-[#00ffff] outline-none hover:bg-[#1a1a1a] cursor-pointer rounded-sm min-w-[110px]">
                        <option value="ALL">KEY: ALL</option>
                    </select>

                    <!-- Signal Filter Buttons -->
                    <div class="flex border border-[#333333] bg-black text-xs" id="signalFilters">
                        <button class="filter-btn px-3 py-1 font-bold border-r border-[#333333] bg-[#333333] text-white" data-val="ALL">ALL</button>
                        <button class="filter-btn px-3 py-1 font-bold border-r border-[#333333] text-[#aaaaaa]" data-val="BULL">BULL</button>
                        <button class="filter-btn px-3 py-1 font-bold border-r border-[#333333] text-[#aaaaaa]" data-val="BEAR">BEAR</button>
                        <button class="filter-btn px-3 py-1 font-bold text-[#aaaaaa]" data-val="FLAT">FLAT</button>
                    </div>

                    <!-- Compact Toggle -->
                    <button id="compactToggle" class="p-1 border border-[#333333] bg-black hover:bg-[#1a1a1a] text-[#aaaaaa] hover:text-white transition-colors" title="ÏöîÏïΩ Î™®Îìú Ï†ÑÌôò">
                        <svg id="icon-minimize" class="hidden" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 14 10 14 10 20"></polyline><polyline points="20 10 14 10 14 4"></polyline><line x1="14" y1="10" x2="21" y2="3"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>
                        <svg id="icon-maximize" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>
                    </button>
                </div>
            </div>

            <!-- ANALYTICS PANEL -->
            <div class="flex flex-col border-b border-[#333333] bg-[#0a0a0a]">
                
                <!-- 1. Monthly Trend (Accordion) -->
                <div class="w-full border-b border-[#333333] p-3 md:px-4">
                    <div class="flex items-center justify-between cursor-pointer group" id="trendToggleBtn">
                        <h2 class="text-[#00ffff] text-[11px] font-bold flex items-center gap-1 uppercase group-hover:text-white transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg> 
                            Monthly Trend
                        </h2>
                        <div class="text-[10px] text-[#555555] tracking-wider group-hover:text-[#00ffff] transition-colors" id="trendToggleText">
                            [+] EXPAND
                        </div>
                    </div>
                    <div id="trendTableContainer" class="overflow-x-auto mt-3 border-t border-[#222] pt-3 hidden">
                        <!-- JS renders vertical table here -->
                    </div>
                </div>

                <!-- 2. Hot Tags Ticker (Independent of Filter) -->
                <div class="w-full p-3 md:px-4">
                    <h2 class="text-[#00ffff] text-[11px] font-bold mb-2 flex items-center gap-1 uppercase">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="22" y1="12" x2="18" y2="12"></line><line x1="6" y1="12" x2="2" y2="12"></line><line x1="12" y1="6" x2="12" y2="2"></line><line x1="12" y1="22" x2="12" y2="18"></line></svg>
                        HOT TAGS [<span id="hotTagsMonth">--</span>] <span class="text-[#555] ml-2 animate-pulse">‚óè LIVE</span>
                    </h2>
                    
                    <div class="relative w-full" id="tickerContainer">
                        <div id="tickerView" class="bg-[#111111] border border-[#333333] p-2 h-[42px] flex items-center overflow-hidden cursor-crosshair ticker-animate">
                            <!-- JS renders current ticker rank -->
                        </div>

                        <div id="hoverView" class="absolute top-0 left-0 w-full bg-[#111111] p-4 z-50 hover-panel shadow-[0_15px_40px_rgba(0,0,0,0.9)] border border-[#00ffff] opacity-0 -translate-y-2 invisible">
                            <!-- JS renders full TOP 5 list -->
                        </div>
                    </div>
                    <div id="tickerHint" class="text-[10px] text-[#555555] mt-1 text-right tracking-wider">&gt;&gt; HOVER TO EXPAND FULL RANKING</div>
                </div>
            </div>

            <!-- Data Grid -->
            <div class="overflow-x-auto flex-1 h-[500px] md:h-auto">
                <table class="w-full text-left border-collapse whitespace-nowrap md:whitespace-normal relative z-0">
                    <thead>
                        <tr class="bg-[#111111] border-b-2 border-[#444444] text-xs text-[#00ffff] tracking-wider uppercase">
                            <th class="p-2 w-24">Time</th>
                            <th class="p-2 w-20 text-center">Sig</th>
                            <th class="p-2 w-28 text-center">Region</th>
                            <th class="p-2 w-28 text-center">Keyword</th>
                            <th class="p-2">Headline / AI Summary</th>
                            <th class="p-2 w-32">Source</th>
                        </tr>
                    </thead>
                    <tbody class="text-[13px]" id="newsTableBody">
                        <tr><td colspan="6" class="p-10 text-center text-[#ffb000] animate-pulse font-bold tracking-widest uppercase">BOOTING TERMINAL... LOADING DATA</td></tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Status Bar -->
            <div class="p-2 bg-[#111111] border-t border-[#333333] text-[10px] text-[#555555] flex justify-between uppercase tracking-widest mt-auto">
                <span>SYS: LIVE (GH_ACTIONS)</span>
                <span id="updateTime">UPDATE: --</span>
                <span>v4.1 // ARCHIVE_TOGGLE_MODE</span>
            </div>

        </div>
    </div>

    <script>
        // --- 1. State Management ---
        let allData = [];
        let filteredData = [];
        let monthlyStats = [];
        let topTags = { regions: [], keywords: [], currentMonth: '' };
        
        let filterSignal = 'ALL';
        let filterRegion = 'ALL';
        let filterKeyword = 'ALL';
        let filterDate = 'ALL'; 
        
        let isCompact = false;
        let isTrendExpanded = false;
        
        let tickerIndex = 0;
        let isTickerHovered = false;
        let tickerInterval;

        const sigColors = {
            BULL: "text-[#00ff00] bg-[#002200] border-[#00ff00]",
            BEAR: "text-[#ff0000] bg-[#220000] border-[#ff0000]",
            FLAT: "text-[#aaaaaa] bg-[#222222] border-[#555555]"
        };

        // --- 2. Data Parsing Helpers ---
        function parseMeta(summary, field) {
            if (!summary) return 'Unknown';
            const regex = new RegExp(field + ':\\s*([^\\n]+)', 'i');
            const match = summary.match(regex);
            return match ? match[1].trim() : 'Unknown';
        }

        function cleanSummary(summary) {
            if (!summary) return 'ÏöîÏïΩ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.';
            return summary.replace(/(Region|Keyword|Signal):.*(\n|$)/gi, '').trim();
        }

        // --- 3. CSV Ingestion ---
        const CSV_URL = "https://raw.githubusercontent.com/lmu1/budongsanSZ2/main/news_data_latest.csv";
        
        function initTerminal() {
            Papa.parse(`${CSV_URL}?nocache=${Date.now()}`, {
                download: true,
                header: true,
                complete: function(results) {
                    allData = results.data
                        .filter(row => row.title && row.collected_at)
                        .map(row => ({
                            ...row,
                            region: parseMeta(row.summary, 'Region'),
                            keyword: parseMeta(row.summary, 'Keyword')
                        }));

                    allData.sort((a, b) => new Date(b.collected_at) - new Date(a.collected_at));
                    
                    if (allData.length > 0) {
                        document.getElementById('updateTime').innerText = `UPDATE: ${allData[0].collected_at}`;
                    }

                    calculateAnalytics();
                    renderSidebarTree();
                    updateFilterOptions(); 
                    applyFilters();
                    startTicker();
                },
                error: function() {
                    document.getElementById('newsTableBody').innerHTML = `<tr><td colspan="6" class="p-10 text-center text-[#ff0000] font-bold uppercase tracking-widest">ERROR: CRITICAL_DATA_FAILURE</td></tr>`;
                    document.getElementById('sidebar-tree').innerHTML = `<div class="text-[#ff0000] text-center">DIR ERROR</div>`;
                }
            });
        }

        // --- 4. Sidebar Tree Logic ---
        function renderSidebarTree() {
            const tree = {};
            
            allData.forEach(d => {
                if(!d.collected_at) return;
                const [datePart] = d.collected_at.split(' ');
                if(!datePart) return;
                
                const parts = datePart.split('-');
                if(parts.length !== 3) return;
                const [y, m, day] = parts;
                
                if(!tree[y]) tree[y] = { count: 0, months: {} };
                if(!tree[y].months[m]) tree[y].months[m] = { count: 0, days: {} };
                if(!tree[y].months[m].days[day]) tree[y].months[m].days[day] = 0;

                tree[y].count++;
                tree[y].months[m].count++;
                tree[y].months[m].days[day]++;
            });

            let html = `
                <div id="btn-all-time" class="date-node date-active cursor-pointer px-2 py-1.5 mb-3 text-xs tracking-widest transition-colors" onclick="setDateFilter('ALL', event)">
                    > [ALL_TIME]
                </div>
            `;

            Object.keys(tree).sort((a,b)=>b-a).forEach(y => {
                html += `
                <details open class="mb-2">
                    <summary class="cursor-pointer text-[#ffb000] hover:text-white font-bold select-none py-1">
                        ${y}ÎÖÑ <span class="text-[#555] text-[10px]">(${tree[y].count})</span>
                    </summary>
                    <div class="pl-3 border-l border-[#333] ml-[5px] mt-1 flex flex-col gap-1">`;
                
                Object.keys(tree[y].months).sort((a,b)=>b-a).forEach(m => {
                    html += `
                    <details open class="mb-1">
                        <summary class="cursor-pointer text-[#00ffff] hover:text-white font-bold select-none py-0.5">
                            ${m}Ïõî <span class="text-[#555] text-[10px]">(${tree[y].months[m].count})</span>
                        </summary>
                        <div class="pl-4 border-l border-[#333] ml-[5px] mt-1 flex flex-col gap-0.5 pb-1">`;
                    
                    Object.keys(tree[y].months[m].days).sort((a,b)=>b-a).forEach(day => {
                        const dateStr = `${y}-${m}-${day}`;
                        const count = tree[y].months[m].days[day];
                        html += `
                        <div class="date-node cursor-pointer text-[#aaaaaa] hover:text-white hover:bg-[#222] px-2 py-1 text-[11px] transition-colors rounded-sm flex justify-between" onclick="setDateFilter('${dateStr}', event)">
                            <span><span class="text-[#555] mr-1">‚îî</span>${day}Ïùº</span>
                            <span class="text-[#555]">(${count})</span>
                        </div>`;
                    });
                    html += `</div></details>`;
                });
                html += `</div></details>`;
            });

            document.getElementById('sidebar-tree').innerHTML = html;
        }

        window.setDateFilter = function(dateStr, event) {
            filterDate = dateStr;
            
            document.querySelectorAll('.date-node').forEach(n => {
                n.classList.remove('date-active');
                n.classList.add('text-[#aaaaaa]');
            });
            
            if (event && event.currentTarget) {
                event.currentTarget.classList.remove('text-[#aaaaaa]');
                event.currentTarget.classList.add('date-active');
            }
            
            applyFilters();
        };


        // --- 5. Analytics Logic ---
        function calculateAnalytics() {
            const total = allData.length;
            const bull = allData.filter(d => d.signal === 'BULL').length;
            const bear = allData.filter(d => d.signal === 'BEAR').length;
            document.getElementById('top-stats').innerHTML = `
                <span class="text-[#00ffff]">TOT: ${total}</span>
                <span class="text-[#00ff00]">BUL: ${bull}</span>
                <span class="text-[#ff0000]">BER: ${bear}</span>
            `;

            const grouped = {};
            allData.forEach(d => {
                const month = d.collected_at.substring(0, 7);
                if (!grouped[month]) grouped[month] = { month, BULL: 0, BEAR: 0, FLAT: 0, TOTAL: 0 };
                const sig = d.signal || 'FLAT';
                if(grouped[month][sig] !== undefined) grouped[month][sig]++;
                grouped[month].TOTAL++;
            });
            monthlyStats = Object.values(grouped).sort((a, b) => b.month.localeCompare(a.month));
            renderMonthlyTrend();

            if(monthlyStats.length > 0) {
                const monthStr = monthlyStats[0].month;
                topTags.currentMonth = monthStr;
                document.getElementById('hotTagsMonth').innerText = monthStr;
                
                const currentMonthData = allData.filter(d => d.collected_at.startsWith(monthStr));
                const regCount = {};
                const keyCount = {};
                
                currentMonthData.forEach(d => {
                    if(d.region && d.region !== 'Unknown') regCount[d.region] = (regCount[d.region] || 0) + 1;
                    if(d.keyword && d.keyword !== 'Unknown') keyCount[d.keyword] = (keyCount[d.keyword] || 0) + 1;
                });

                const sort5 = (obj) => Object.entries(obj).sort((a, b) => b[1] - a[1]).slice(0, 5);
                topTags.regions = sort5(regCount);
                topTags.keywords = sort5(keyCount);
                
                renderTickerViews();
            }
        }

        // --- 6. UI Rendering & Filter Logic ---
        function updateFilterOptions() {
            const rSelect = document.getElementById('regionFilter');
            const kSelect = document.getElementById('keywordFilter');
            
            const currentR = filterRegion;
            const currentK = filterKeyword;

            const availableRegions = [...new Set(allData
                .filter(d => (filterKeyword === 'ALL' || d.keyword === filterKeyword) && 
                             (filterSignal === 'ALL' || d.signal === filterSignal) &&
                             (filterDate === 'ALL' || d.collected_at.startsWith(filterDate)))
                .map(d => d.region)
                .filter(r => r && r !== 'Unknown')
            )].sort();

            const availableKeywords = [...new Set(allData
                .filter(d => (filterRegion === 'ALL' || d.region === filterRegion) && 
                             (filterSignal === 'ALL' || d.signal === filterSignal) &&
                             (filterDate === 'ALL' || d.collected_at.startsWith(filterDate)))
                .map(d => d.keyword)
                .filter(k => k && k !== 'Unknown')
            )].sort();

            rSelect.innerHTML = '<option value="ALL">REG: ALL</option>';
            availableRegions.forEach(r => {
                const opt = document.createElement('option');
                opt.value = r;
                opt.textContent = `REG: ${r}`;
                if(r === currentR) opt.selected = true;
                rSelect.appendChild(opt);
            });

            kSelect.innerHTML = '<option value="ALL">KEY: ALL</option>';
            availableKeywords.forEach(k => {
                const opt = document.createElement('option');
                opt.value = k;
                opt.textContent = `KEY: ${k}`;
                if(k === currentK) opt.selected = true;
                kSelect.appendChild(opt);
            });
        }

        function applyFilters() {
            filteredData = allData.filter(d => {
                const sMatch = filterSignal === 'ALL' || d.signal === filterSignal;
                const rMatch = filterRegion === 'ALL' || d.region === filterRegion;
                const kMatch = filterKeyword === 'ALL' || d.keyword === filterKeyword;
                const dMatch = filterDate === 'ALL' || (d.collected_at && d.collected_at.startsWith(filterDate));
                return sMatch && rMatch && kMatch && dMatch;
            });
            renderTable(filteredData);
            updateFilterOptions();
        }

        function renderMonthlyTrend() {
            const container = document.getElementById('trendTableContainer');
            if(monthlyStats.length === 0) return;

            let header = `<th class="pb-2 text-left w-24 text-[#555555] font-normal text-[10px]">METRIC</th>`;
            let bullRow = `<td class="py-2 text-left text-[#00ff00] font-bold text-xs tracking-widest">BULL</td>`;
            let bearRow = `<td class="py-2 text-left text-[#ff0000] font-bold text-xs tracking-widest">BEAR</td>`;
            let flatRow = `<td class="py-2 text-left text-[#aaaaaa] font-bold text-xs tracking-widest">FLAT</td>`;
            let totalRow = `<td class="py-2 text-left text-white font-bold text-xs tracking-widest">TOTAL</td>`;

            monthlyStats.forEach(s => {
                const [y, m] = s.month.split('-');
                header += `<th class="pb-2 w-20"><div class="text-[10px] text-[#555555] font-normal tracking-widest">${y}</div><div class="text-[#00ffff] font-bold">${parseInt(m)}Ïõî</div></th>`;
                bullRow += `<td class="py-2 text-[#00ff00] font-bold">${s.BULL}</td>`;
                bearRow += `<td class="py-2 text-[#ff0000] font-bold">${s.BEAR}</td>`;
                flatRow += `<td class="py-2 text-[#aaaaaa] font-bold">${s.FLAT}</td>`;
                totalRow += `<td class="py-2 text-white font-bold">${s.TOTAL}</td>`;
            });

            container.innerHTML = `
                <table class="w-full md:w-auto text-[13px] text-center border-collapse">
                    <thead><tr class="border-b border-[#333333]">${header}</tr></thead>
                    <tbody>
                        <tr class="border-b border-[#222222] hover:bg-[#111111]">${bullRow}</tr>
                        <tr class="border-b border-[#222222] hover:bg-[#111111]">${bearRow}</tr>
                        <tr class="border-b border-[#222222] hover:bg-[#111111]">${flatRow}</tr>
                        <tr class="hover:bg-[#111111]">${totalRow}</tr>
                    </tbody>
                </table>
            `;
        }

        function renderTickerViews() {
            const hoverEl = document.getElementById('hoverView');
            let regHtml = topTags.regions.map((r, i) => `
                <div class="flex justify-between text-[13px] py-1.5 hover:bg-[#222]">
                    <span class="text-white"><span class="text-[#555] mr-2">${i+1}.</span>${r[0]}</span>
                    <span class="text-[#aaaaaa] font-bold">${r[1]}</span>
                </div>`).join('');
            let keyHtml = topTags.keywords.map((k, i) => `
                <div class="flex justify-between text-[13px] py-1.5 hover:bg-[#222]">
                    <span class="text-white"><span class="text-[#555] mr-2">${i+1}.</span>${k[0]}</span>
                    <span class="text-[#ffb000] font-bold">${k[1]}</span>
                </div>`).join('');

            hoverEl.innerHTML = `
                <div class="flex flex-col md:flex-row gap-8">
                    <div class="w-full md:w-1/2">
                        <div class="text-[#00ffff] text-[11px] font-bold mb-3 border-b border-[#333] pb-1 uppercase">TOP REGIONS</div>
                        ${regHtml}
                    </div>
                    <div class="w-full md:w-1/2">
                        <div class="text-[#ffb000] text-[11px] font-bold mb-3 border-b border-[#333] pb-1 uppercase">TOP KEYWORDS</div>
                        ${keyHtml}
                    </div>
                </div>
            `;
            updateTickerFrame();
        }

        function updateTickerFrame() {
            if(topTags.regions.length === 0) return;
            const reg = topTags.regions[tickerIndex];
            const kw = topTags.keywords[tickerIndex];

            document.getElementById('tickerView').innerHTML = `
                <div class="flex items-center gap-4 absolute w-full ${isTickerHovered ? 'opacity-0' : 'opacity-100'} transition-opacity duration-300">
                    ${reg ? `<div class="flex items-center gap-2 whitespace-nowrap"><span class="bg-[#333333] text-white px-2 py-0.5 text-[10px] rounded-sm">REG RANK ${tickerIndex + 1}</span><span class="text-[#00ffff] font-bold text-sm">${reg[0]}</span><span class="text-[#aaaaaa] text-[11px]">(${reg[1]})</span></div>` : ''}
                    <span class="text-[#555555] mx-4">|</span>
                    ${kw ? `<div class="flex items-center gap-2 whitespace-nowrap"><span class="bg-[#333333] text-white px-2 py-0.5 text-[10px] rounded-sm">KEY RANK ${tickerIndex + 1}</span><span class="text-[#ffb000] font-bold text-sm">${kw[0]}</span><span class="text-[#aaaaaa] text-[11px]">(${kw[1]})</span></div>` : ''}
                </div>
            `;
        }

        function startTicker() {
            clearInterval(tickerInterval);
            tickerInterval = setInterval(() => {
                if (!isTickerHovered) {
                    tickerIndex = (tickerIndex + 1) % Math.max(topTags.regions.length, 1);
                    updateTickerFrame();
                }
            }, 2500);
        }

        function renderTable(data) {
            const body = document.getElementById('newsTableBody');
            if(data.length === 0) {
                body.innerHTML = `<tr><td colspan="6" class="p-10 text-center text-[#ff0000] uppercase font-bold tracking-widest">DATA_NOT_FOUND_FOR_CRITERIA</td></tr>`;
                return;
            }

            let html = '';
            data.forEach(item => {
                const ts = item.collected_at ? item.collected_at.split(' ') : ['--', '--'];
                const sigClass = sigColors[item.signal] || sigColors['FLAT'];
                const sum = cleanSummary(item.summary);

                html += `
                    <tr class="border-b border-[#222222] hover:bg-[#111111] group transition-colors">
                        <td class="p-2 text-[#00ffff] font-mono">${ts[1]}<br/><span class="text-[10px] text-[#555]">${ts[0]}</span></td>
                        <td class="p-2 text-center"><span class="inline-block w-full text-center px-1 py-0.5 border font-bold text-[11px] tracking-wider ${sigClass}">${item.signal || 'FLAT'}</span></td>
                        <td class="p-2 text-center font-bold text-[#ffb000]">${item.region}</td>
                        <td class="p-2 text-center text-[#ffb000]">[${item.keyword}]</td>
                        <td class="p-2 py-3 min-w-[300px]">
                            <a href="${item.link}" target="_blank" class="font-sans font-bold text-white hover:text-[#00ffff] hover:underline leading-snug">
                                ${item.title}
                            </a>
                        </td>
                        <td class="p-2 text-[#aaaaaa]"><span class="text-[#ffb000] font-bold">${item.publisher || 'Unknown'}</span><br/><span class="text-[10px] opacity-70">(${item.reporter || 'Unknown'})</span></td>
                    </tr>
                `;
                
                if(!isCompact) {
                    html += `
                    <tr class="border-b border-[#333333] bg-[#0a0a0a]">
                        <td colspan="4"></td>
                        <td colspan="2" class="p-2 pt-1 pb-4 text-[#cccccc] font-sans leading-relaxed text-[13px]">
                            <div class="flex gap-2 items-start opacity-90">
                                <span class="text-[#555555] select-none font-mono">&gt;&gt;</span>
                                <span class="line-clamp-2 md:line-clamp-none whitespace-normal">${sum}</span>
                            </div>
                        </td>
                    </tr>`;
                }
            });
            body.innerHTML = html;
        }

        // --- 7. Event Listeners ---
        
        // üöÄ NEW: Archive Sidebar Toggle Logic
        document.getElementById('toggleArchiveBtn').addEventListener('click', () => {
            const sidebar = document.getElementById('timeArchiveSidebar');
            const btnText = document.getElementById('archiveBtnText');
            
            const isHidden = sidebar.classList.contains('hidden');
            if(isHidden) {
                sidebar.classList.remove('hidden');
                sidebar.classList.add('flex');
                btnText.innerText = '[-] CLOSE ARCHIVE';
            } else {
                sidebar.classList.add('hidden');
                sidebar.classList.remove('flex');
                btnText.innerText = '[+] TIME ARCHIVE';
            }
        });

        document.getElementById('regionFilter').addEventListener('change', e => { 
            filterRegion = e.target.value; applyFilters(); 
        });
        
        document.getElementById('keywordFilter').addEventListener('change', e => { 
            filterKeyword = e.target.value; applyFilters(); 
        });

        // Reset All Filters Button
        document.getElementById('resetAllFilters').addEventListener('click', () => {
            filterSignal = 'ALL';
            filterRegion = 'ALL';
            filterKeyword = 'ALL';
            
            setDateFilter('ALL', null);
            document.getElementById('btn-all-time').classList.add('date-active');
            document.getElementById('btn-all-time').classList.remove('text-[#aaaaaa]');

            document.querySelectorAll('#signalFilters .filter-btn').forEach(b => {
                b.classList.remove('bg-[#333333]', 'text-white');
                b.classList.add('text-[#aaaaaa]');
                if(b.dataset.val === 'ALL') {
                    b.classList.add('bg-[#333333]', 'text-white');
                    b.classList.remove('text-[#aaaaaa]');
                }
            });
            
            applyFilters();
        });
        
        document.querySelectorAll('#signalFilters .filter-btn').forEach(btn => {
            btn.addEventListener('click', e => {
                document.querySelectorAll('#signalFilters .filter-btn').forEach(b => {
                    b.classList.remove('bg-[#333333]', 'text-white');
                    b.classList.add('text-[#aaaaaa]');
                });
                e.target.classList.add('bg-[#333333]', 'text-white');
                e.target.classList.remove('text-[#aaaaaa]');
                filterSignal = e.target.getAttribute('data-val');
                applyFilters();
            });
        });

        document.getElementById('compactToggle').addEventListener('click', () => {
            isCompact = !isCompact;
            document.getElementById('icon-minimize').classList.toggle('hidden');
            document.getElementById('icon-maximize').classList.toggle('hidden');
            applyFilters();
        });

        document.getElementById('trendToggleBtn').addEventListener('click', () => {
            isTrendExpanded = !isTrendExpanded;
            const container = document.getElementById('trendTableContainer');
            const text = document.getElementById('trendToggleText');
            container.classList.toggle('hidden');
            text.innerText = isTrendExpanded ? '[-] COLLAPSE' : '[+] EXPAND';
        });

        const tickerContainer = document.getElementById('tickerContainer');
        tickerContainer.addEventListener('mouseenter', () => {
            isTickerHovered = true;
            updateTickerFrame();
            const hv = document.getElementById('hoverView');
            hv.classList.remove('opacity-0', '-translate-y-2', 'invisible');
            hv.classList.add('opacity-100', 'translate-y-0', 'visible');
        });

        tickerContainer.addEventListener('mouseleave', () => {
            isTickerHovered = false;
            updateTickerFrame();
            const hv = document.getElementById('hoverView');
            hv.classList.add('opacity-0', '-translate-y-2', 'invisible');
            hv.classList.remove('opacity-100', 'translate-y-0', 'visible');
        });

        window.onload = initTerminal;
    </script>
</body>
</html>
